"use strict";(self.webpackChunkgefyra=self.webpackChunkgefyra||[]).push([[1570],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>h});var a=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var s=a.createContext({}),u=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},c=function(e){var t=u(e.components);return a.createElement(s.Provider,{value:t},e.children)},p="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,s=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),p=u(n),m=o,h=p["".concat(s,".").concat(m)]||p[m]||d[m]||r;return n?a.createElement(h,l(l({ref:t},c),{},{components:n})):a.createElement(h,l({ref:t},c))}));function h(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,l=new Array(r);l[0]=m;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i[p]="string"==typeof e?e:o,l[1]=i;for(var u=2;u<r;u++)l[u]=n[u];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},8153:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>l,default:()=>d,frontMatter:()=>r,metadata:()=>i,toc:()=>u});var a=n(7462),o=(n(7294),n(3905));const r={title:"Remote Development on Google Kubernetes Engine"},l="Developing a backend application with Django on the Google Kubernetes Engine (GKE)",i={unversionedId:"usecases/remote-gke",id:"version-1.x/usecases/remote-gke",title:"Remote Development on Google Kubernetes Engine",description:"Intermediate Usecase",source:"@site/versioned_docs/version-1.x/usecases/remote-gke.md",sourceDirName:"usecases",slug:"/usecases/remote-gke",permalink:"/docs/1.x/usecases/remote-gke",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/versioned_docs/version-1.x/usecases/remote-gke.md",tags:[],version:"1.x",frontMatter:{title:"Remote Development on Google Kubernetes Engine"},sidebar:"docsSidebar",previous:{title:"OAuth2 Demo with a Sidecar",permalink:"/docs/1.x/usecases/oauth2-demo"},next:{title:"Developing Go Applications with Gefyra",permalink:"/docs/1.x/usecases/golang"}},s={},u=[{value:"What you will learn",id:"what-you-will-learn",level:3},{value:"Prerequisites",id:"prerequisites",level:2},{value:"Setup a cluster",id:"setup-a-cluster",level:2},{value:"Running the Spacecrafts Demo",id:"running-the-spacecrafts-demo",level:2},{value:"Setting up Gefyra",id:"setting-up-gefyra",level:2},{value:"Local development backed by the cluster",id:"local-development-backed-by-the-cluster",level:2}],c={toc:u},p="wrapper";function d(e){let{components:t,...n}=e;return(0,o.kt)(p,(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"developing-a-backend-application-with-django-on-the-google-kubernetes-engine-gke"},"Developing a backend application with Django on the Google Kubernetes Engine (GKE)"),(0,o.kt)("p",null,"Intermediate Usecase"),(0,o.kt)("p",null,"This guide will show you how to use Gefyra for the local development of a Kubernetes\nApplication running in GKE. Gefyra is able to spin up a local container which\nbehaves like it was part of the cluster already. This way you can run services\ninside the cluster without abstaining from features like hot code reload. Sounds\ngood? Lets go!"),(0,o.kt)("p",null,"This is more of an advanced use-case, if you just want an easy example of how Gefyra works, check\nout the ",(0,o.kt)("a",{parentName:"p",href:"https://gefyra.dev/getting-started/"},"getting started guide"),"."),(0,o.kt)("hr",null),(0,o.kt)("h3",{id:"what-you-will-learn"},"What you will learn"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"How to set up a Kubernetes cluster with the Google Kubernetes Engine"),(0,o.kt)("li",{parentName:"ul"},"Deploy a Django-based demo application "),(0,o.kt)("li",{parentName:"ul"},"Set out with Gefyra to run a local container instance as part of the remote cluster",(0,o.kt)("hr",null))),(0,o.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,o.kt)("p",null,"To follow this guide, you need to have the following tools installed:"),(0,o.kt)("p",null,"You need to have the following tools installed:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://cloud.google.com/sdk/docs/install-sdk"},"gcloud")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://kubernetes.io/docs/tasks/tools/"},"kubectl")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://helm.sh/docs/intro/install/"},"Helm")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://gefyra.dev/installation/"},"Gefyra"))),(0,o.kt)("p",null,"Additionally you need an account for the Google Cloud Platform including the\npermission to create a new cluster. Make sure your gcloud is using the right\nproject configuration. Googles documentation is available\n",(0,o.kt)("a",{parentName:"p",href:"https://cloud.google.com/docs/get-started"},"here"),"."),(0,o.kt)("h2",{id:"setup-a-cluster"},"Setup a cluster"),(0,o.kt)("p",null,"In this guide we will spin up a small demo application called spacecrafts,\nfeaturing Django Hurricane. If you already have a cluster running, you are free\nto use this as well."),(0,o.kt)("p",null,"The easiest way to create a new cluster is using ",(0,o.kt)("inlineCode",{parentName:"p"},"gcloud"),":"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"gcloud container clusters create spacecraft"),"."),(0,o.kt)("p",null,"This may take a few minutes, there will be 3 VM instances running a kubernetes\ncluster ready to serve your applications. ",(0,o.kt)("inlineCode",{parentName:"p"},"gcloud")," will set your\nkubectl context to the created cluster, nothing to worry about!"),(0,o.kt)("p",null,"The last thing we need to do is open a port in the firewall. This allows gefyra\nto connect to the cluster using wireguard:"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"gcloud compute firewall-rules create gefyra --allow udp:31820")),(0,o.kt)("h2",{id:"running-the-spacecrafts-demo"},"Running the Spacecrafts Demo"),(0,o.kt)("p",null,"To have some actual application to develop against, we want to deploy our\nspacecrafts demo to our cluster. Clone the repository and deploy it using helm:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"git clone https://github.com/django-hurricane/spacecrafts-demo.git\ncd spacecrafts-demo/helm\nhelm install spacecrafts spacecrafts/\n")),(0,o.kt)("p",null,"Check if everything is up and running with ",(0,o.kt)("inlineCode",{parentName:"p"},"kubectl get pods"),"."),(0,o.kt)("p",null,"Now we need to deploy a load balancer so Google exposes our service on a public\nIP.  Use the following service definition with ",(0,o.kt)("inlineCode",{parentName:"p"},"kubectl apply -f\nservice.yaml"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: v1\nkind: Service\nmetadata:\n  name: hello\nspec:\n  type: LoadBalancer\n  selector:\n    app.kubernetes.io/name: spacecrafts\n  strategy:\n  ports:\n  - port: 80\n    targetPort: 8080\n---\n")),(0,o.kt)("p",null,"It takes some time to actually get an IP. You can check the state running\n",(0,o.kt)("inlineCode",{parentName:"p"},"kubectl get service"),". There will be a service named ",(0,o.kt)("inlineCode",{parentName:"p"},"hello")," of the type\n",(0,o.kt)("inlineCode",{parentName:"p"},"LoadBalancer"),". As soon as an IP is available, feel free to visit it in your\nbrowser. If you can see a 404 error from Django, everything is alright!"),(0,o.kt)("h2",{id:"setting-up-gefyra"},"Setting up Gefyra"),(0,o.kt)("p",null,"Now we can run ",(0,o.kt)("inlineCode",{parentName:"p"},"gefyra up"),". This way gefyra sets up all requirements\nto enjoy local development supported by services in the cluster."),(0,o.kt)("p",null,"At first, we need a host IP of one of our compute instances. You can get\nthem with running ",(0,o.kt)("inlineCode",{parentName:"p"},"gcloud compute instances list"),". Pick one of them."),(0,o.kt)("p",null,"Now you can run ",(0,o.kt)("inlineCode",{parentName:"p"},"gefyra up --host <IP>"),"."),(0,o.kt)("p",null,"Gefyra now sets up a wireguard connection into the cluster and prepares\neverything to allow us to run local containers linked to the cluster."),(0,o.kt)("h2",{id:"local-development-backed-by-the-cluster"},"Local development backed by the cluster"),(0,o.kt)("p",null,"Lets say we want to debug and fix the 404 on the index page. It's possible to do\nthis in the remote cluster, but Gefyra enables us to do this on your machine!"),(0,o.kt)("p",null,"The following command will spin your local development container for spacecrafts\nup. Please note you need to adjust the name of the container, run ",(0,o.kt)("inlineCode",{parentName:"p"},"kubectl get\npods")," to get the right identifier."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"export podname=$(kubectl get pods --no-headers -o custom-columns=\":metadata.name\" | grep -v postgres)\ngefyra run --env-from $podname/spacecrafts \\\n -i quay.io/django-hurricane/spacecrafts-demo \\\n -N myspacecraft \\\n -v src/:/app \\\n -c \"python manage.py serve \n  --autoreload \n  --static \n  --command 'collectstatic \n  --noinput' \n  --command 'migrate'\" \n")),(0,o.kt)("p",null,"Some explanation: We pass the image for the container with ",(0,o.kt)("inlineCode",{parentName:"p"},"-i"),", name the container with ",(0,o.kt)("inlineCode",{parentName:"p"},"-N"),", mount our\nsource directory inside the container for hot-reloading using ",(0,o.kt)("inlineCode",{parentName:"p"},"-v")," and specify the command to be executed\non startup."),(0,o.kt)("p",null,"Thats it. To get the IP of the container, run "),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"gefyra list --containers")),(0,o.kt)("p",null,"Now you can open your browser at ",(0,o.kt)("inlineCode",{parentName:"p"},"<ip>:8000")," and get the same ",(0,o.kt)("inlineCode",{parentName:"p"},"404-Error"),". You can watch the logs using\n",(0,o.kt)("inlineCode",{parentName:"p"},"docker logs -f myspacecraft"),"."),(0,o.kt)("p",null,"The reason why we get a 404 not found is simply a missing route. We should add one in ",(0,o.kt)("inlineCode",{parentName:"p"},"src/configuration/urls.py"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-diff"},' urlpatterns = [\n     # django-admin:\n+    path("", csrf_exempt(GraphQLView.as_view(graphiql=True))),\n     path("admin/doc/", include(admindocs_urls)),  # noqa: DJ05\n     path("admin/", admin.site.urls),\n     path("graphql/", csrf_exempt(GraphQLView.as_view(graphiql=True))),\n')),(0,o.kt)("p",null,"If you now reload your browser tab, you should see a graphql input field!"))}d.isMDXComponent=!0}}]);