<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-1.x plugin-docs plugin-id-default docs-doc-id-usecases/oauth2-demo">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">OAuth2 Demo with a Sidecar | Gefyra | Blazingly-fast rocket, rock-solid, local application development arrow_right with Kubernetes.</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://gefyra.dev/img/docusaurus-social-card.png"><meta data-rh="true" name="twitter:image" content="https://gefyra.dev/img/docusaurus-social-card.png"><meta data-rh="true" property="og:url" content="https://gefyra.dev/docs/1.x/usecases/oauth2-demo"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="1.x"><meta data-rh="true" name="docusaurus_tag" content="docs-default-1.x"><meta data-rh="true" name="docsearch:version" content="1.x"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-1.x"><meta data-rh="true" property="og:title" content="OAuth2 Demo with a Sidecar | Gefyra | Blazingly-fast rocket, rock-solid, local application development arrow_right with Kubernetes."><meta data-rh="true" name="description" content="Advanced Usecase"><meta data-rh="true" property="og:description" content="Advanced Usecase"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://gefyra.dev/docs/1.x/usecases/oauth2-demo"><link data-rh="true" rel="alternate" href="https://gefyra.dev/docs/1.x/usecases/oauth2-demo" hreflang="en"><link data-rh="true" rel="alternate" href="https://gefyra.dev/docs/1.x/usecases/oauth2-demo" hreflang="x-default"><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-MDH0PRFGS1"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-MDH0PRFGS1",{anonymize_ip:!0})</script>
<link rel="preconnect" href="https://www.googletagmanager.com">
<script>window.dataLayer=window.dataLayer||[]</script>
<script>!function(e,t,a,n,g){e[n]=e[n]||[],e[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var m=t.getElementsByTagName(a)[0],r=t.createElement(a);r.async=!0,r.src="https://www.googletagmanager.com/gtm.js?id=GTM-MZZHWCF",m.parentNode.insertBefore(r,m)}(window,document,"script","dataLayer")</script>





<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700,800&amp;display=swap"><link rel="stylesheet" href="/assets/css/styles.a483873a.css">
<link rel="preload" href="/assets/js/runtime~main.7dcd39c8.js" as="script">
<link rel="preload" href="/assets/js/main.4d529139.js" as="script">
</head>
<body class="navigation-with-keyboard">
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MZZHWCF" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:#ebedf0;color:#1c1e21" role="banner"><div class="content_knG7 announcementBarContent_xLdY">If you like Gefyra, please give us a ⭐ star on <a target="_blank" href="https://github.com/gefyrahq/gefyra/">GitHub</a> and support this project.</div></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/gefyra_horizontal_logo.svg" alt="Gefyra Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/gefyra_horizontal_logo_dark.svg" alt="Gefyra Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/docs/1.x/">1.x</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/">2.0.0</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/1.x/usecases/oauth2-demo">1.x</a></li></ul></div><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/1.x/">Docs</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/usecases-and-demos/">Usecases and Demos</a><a class="navbar__item navbar__link" href="/media">Media</a><a class="navbar__item navbar__link" href="/about">About</a><a href="https://github.com/gefyrahq/gefyra" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><iframe style="margin-top: 8px;" src="https://ghbtns.com/github-btn.html?user=gefyrahq&repo=gefyra&type=star&count=true" frameborder="0" scrolling="0" width="150" height="20" title="GitHub"></iframe></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/1.x/">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/1.x/installation">Installation</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/1.x/getting-started/">Getting Started</a><button aria-label="Toggle the collapsible sidebar category &#x27;Getting Started&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/1.x/cli">Command Line Interface (CLI)</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/1.x/tech/">Technical Details</a><button aria-label="Toggle the collapsible sidebar category &#x27;Technical Details&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/1.x/run_vs_bridge">Run vs Bridge</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/1.x/docker-extension">Docker Desktop Extension</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/1.x/usecases/">Use Cases and Demos</a><button aria-label="Toggle the collapsible sidebar category &#x27;Use Cases and Demos&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.x/usecases/ubuntu-in-namespace">Run a Ubuntu container instance</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/1.x/usecases/oauth2-demo">OAuth2 Demo with a Sidecar</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.x/usecases/remote-gke">Remote Development on Google Kubernetes Engine</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.x/usecases/golang">Developing Go Applications with Gefyra</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/1.x/enterprise">Enterprise Support</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/1.x/media">Media</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/1.x/about">About</a></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><span class="theme-doc-version-badge badge badge--secondary">Version: 1.x</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Create a Backend Application with a Sidecar and OAuth2 Authentication</h1><p>Advanced Usecase</p><p>This example demonstrates how to develop a Kubernetes sidecar pattern for an OAuth2 (OpenID Connect) authorized
backend service using Gefyra. </p><p>This is more of an advanced use-case, if you just want an easy example of how Gefyra works, check
out the <a href="https://gefyra.dev/getting-started/" target="_blank" rel="noopener noreferrer">getting started guide</a>.</p><hr><h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-you-will-learn">What you will learn<a href="#what-you-will-learn" class="hash-link" aria-label="Direct link to What you will learn" title="Direct link to What you will learn">​</a></h3><ul><li>Create a (Python-based) backend application that reads a JWT (JSON web token)</li><li>Get a local identity provider with <a href="https://www.keycloak.org/" target="_blank" rel="noopener noreferrer">Keycloak</a> </li><li>Apply the Kubernetes sidecar pattern with <a href="https://oauth2-proxy.github.io/oauth2-proxy/" target="_blank" rel="noopener noreferrer">OAuth2-Proxy</a> and connect the app to Keycloak</li><li>Find and fix a bug</li><li>Start coding locally within the Kubernetes cluster having the sidecar active</li></ul><hr><h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-you-will-need">What you will need<a href="#what-you-will-need" class="hash-link" aria-label="Direct link to What you will need" title="Direct link to What you will need">​</a></h3><ul><li><a href="/docs/installation">Gefyra</a></li><li><a href="https://github.com/Getdeck/getdeck" target="_blank" rel="noopener noreferrer">Getdeck</a> for setting up the development infrastructure (runs on <code>k3d</code>)</li><li>kubectl</li><li>A copy of <a href="https://github.com/gefyrahq/gefyra-demos" target="_blank" rel="noopener noreferrer">https://github.com/gefyrahq/gefyra-demos</a></li><li>Optionally: <a href="https://k3d.io" target="_blank" rel="noopener noreferrer">k3d</a> or any other preferred Kubernetes cluster</li><li>Optionally: VSCode with Python debugger installed (or any other preferred IDE)</li></ul><hr><h3 class="anchor anchorWithStickyNavbar_LWe7" id="table-of-contents">Table of contents<a href="#table-of-contents" class="hash-link" aria-label="Direct link to Table of contents" title="Direct link to Table of contents">​</a></h3><ol><li>TOC</li></ol><p>That&#x27;s about it. Let&#x27;s get started.</p><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="creating-the-development-infrastructure">Creating the Development Infrastructure<a href="#creating-the-development-infrastructure" class="hash-link" aria-label="Direct link to Creating the Development Infrastructure" title="Direct link to Creating the Development Infrastructure">​</a></h2><p>First, we need a Kubernetes-based development infrastructure which contains all required components. Luckily this can
be achieved quite easily with the <a href="https://github.com/Getdeck/getdeck" target="_blank" rel="noopener noreferrer"><code>Deck CLI</code> from here</a>.</p><p>Just run: </p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">deck get --name oauth2-demo https://github.com/gefyrahq/gefyra-demos.git</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>and you will get a fresh <code>k3d</code> cluster running locally with all required components installed. </p><p><strong>Important:</strong> These workloads are intended for demonstration purposes and are not safe for production deployments.</p><p><strong>Optional:</strong> If you don&#x27;t want to create the development infrastructure using <code>Getdeck</code> you can also provide it
yourself. You need:</p><ul><li>a Kubernetes cluster</li><li>an identity provider (preferably Keycloak)<ul><li>a custom realm with an oauth2 client for the backend service</li><li>a test user with required privileges</li><li>ingress config that supports a full-fledged oauth2 login flow</li></ul></li><li>the workload manifests for the backend application with the OAuth2-Proxy sidecar</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="getting-the-app-running">Getting the App Running<a href="#getting-the-app-running" class="hash-link" aria-label="Direct link to Getting the App Running" title="Direct link to Getting the App Running">​</a></h2><p><strong>Optional:</strong> In order to observe the workload booting up, check out
<a href="http://dashboard.127.0.0.1.nip.io:8080/#/workloads?namespace=oauth2-demo" target="_blank" rel="noopener noreferrer">the Kubernetes dashboard</a> coming with this <code>deck</code>.<br>
<!-- -->A healthy cluster looks like this:  </p><div align="center"><img loading="lazy" src="/img/usecases_oauth2-demo_dashboard1.png" alt="the kubernetes dashboard" class="img_ev3q"></div><p>Once you have the workload running in Kubernetes, head over to
<a href="http://oauth2-demo.127.0.0.1.nip.io:8080/" target="_blank" rel="noopener noreferrer">http://oauth2-demo.127.0.0.1.nip.io:8080/</a>.  </p><p>The following page should come up asking you to sign in with <em>OpenID Connect</em>:  </p><div align="center"><img loading="lazy" src="/img/usecases_oauth2-demo_oauth2-proxy.png" alt="the oauth2-proxy login portal" class="img_ev3q"></div><p>Once you click the button you will be redirected to the central login of Keycloak, which looks like this:  </p><div align="center"><img loading="lazy" src="/img/usecases_oauth2-demo_kc-login.png" alt="Keycloak login page" class="img_ev3q"></div><p>Please notice how you got redirected to the local domain of Keycloak (<a href="http://keycloak.127.0.0.1.nip.io:8080/..." target="_blank" rel="noopener noreferrer">http://keycloak.127.0.0.1.nip.io:8080/...</a>).  </p><p>The demo workload contains a prepared user in Keycloak&#x27;s database. You can use it to perform a login. The credentials are as
follows:  </p><p><strong>Username</strong>: <em><a href="mailto:john@gefyra.dev" target="_blank" rel="noopener noreferrer">john@gefyra.dev</a></em><br>
<strong>Password</strong>: <em><a href="mailto:john@gefyra.dev" target="_blank" rel="noopener noreferrer">john@gefyra.dev</a></em>  </p><p>Once you hit the <em>Sign In</em> button you will be redirected back to the beginning, but this time you will see the json output of
the backend service:</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;Hello&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;World&quot;</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Voilà, we have a full-fledged <a href="https://openid.net/connect/" target="_blank" rel="noopener noreferrer">OpenID Connect</a> login flow running in a Kubernetes cluster.<br>
<!-- -->So are we done yet? Not quite. Let&#x27;s move on to the internals.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-scheme-of-the-infrastructure">The Scheme of the Infrastructure<a href="#the-scheme-of-the-infrastructure" class="hash-link" aria-label="Direct link to The Scheme of the Infrastructure" title="Direct link to The Scheme of the Infrastructure">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="kubernetes-overview">Kubernetes Overview<a href="#kubernetes-overview" class="hash-link" aria-label="Direct link to Kubernetes Overview" title="Direct link to Kubernetes Overview">​</a></h3><p>The Kubernetes cluster is running three important components for this use case:</p><ul><li>Keycloak: the identity provider compatible with OpenID Connect (OIDC)</li><li>OAuth2-Proxy: a reverse proxy compatible with OpenID Connect </li><li>Backend Application: a <a href="https://fastapi.tiangolo.com/" target="_blank" rel="noopener noreferrer">FastAPI</a> application</li></ul><p>The OAuth2-Proxy is implemented as a sidecar and runs side-by-side in each <a href="https://kubernetes.io/docs/concepts/workloads/pods/" target="_blank" rel="noopener noreferrer"><em>Pod</em></a> with the backend application. If you are
not yet familiar with the sidecar pattern <a href="https://www.oreilly.com/library/view/designing-distributed-systems/9781491983638/ch02.html" target="_blank" rel="noopener noreferrer">please check out this resource</a>.
Keycloak runs in a <em>StatefulSet</em> and is connected to a <em>PostgreSQL</em> database.  </p><p>The Kubernetes objects of the workload are as follows:  </p><div align="center"><img loading="lazy" src="/img/usecases_oauth2-demo-k8s1.png" alt="Kubernetes object relation" class="img_ev3q"></div><p>In this picture you can find two <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/" target="_blank" rel="noopener noreferrer"><em>Ingresses</em></a>
definitions: one is serving the application <a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/" target="_blank" rel="noopener noreferrer"><em>Deployment</em></a> <em>oauth2-demo</em>
which schedules one <em>Pod</em> under <a href="http://oauth2-demo.127.0.0.1.nip.io:8080" target="_blank" rel="noopener noreferrer">oauth2-demo.127.0.0.1.nip.io:8080</a>, the other is
serving Keycloak under <a href="http://keycloak.127.0.0.1.nip.io:8080" target="_blank" rel="noopener noreferrer">keycloak.127.0.0.1.nip.io:8080</a>.    </p><p><strong>Important:</strong> Please mind that port <em>8080</em> is a port mapping. From within the cluster you will see it running on port <em>80</em>.  </p><p>You can introspect the Ingress also with <code>kubectl</code>:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> kubectl --namespace oauth2-demo get ingress </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                             CLASS    HOSTS                          ADDRESS      PORTS     AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">keycloak                         </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">   keycloak.127.0.0.1.nip.io      </span><span class="token number" style="color:#36acaa">172.23</span><span class="token plain">.0.2   </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">, </span><span class="token number" style="color:#36acaa">443</span><span class="token plain">   56m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">keycloak-console                 </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">   keycloak.127.0.0.1.nip.io      </span><span class="token number" style="color:#36acaa">172.23</span><span class="token plain">.0.2   </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">, </span><span class="token number" style="color:#36acaa">443</span><span class="token plain">   56m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">oauth2-demo                      </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">   oauth2-demo.127.0.0.1.nip.io   </span><span class="token number" style="color:#36acaa">172.23</span><span class="token plain">.0.2   </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">        56m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dashboard-kubernetes-dashboard   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">   dashboard.127.0.0.1.nip.io     </span><span class="token number" style="color:#36acaa">172.23</span><span class="token plain">.0.2   </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">        56m</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The next layer adds the Kubernetes <a href="https://kubernetes.io/docs/concepts/services-networking/service/" target="_blank" rel="noopener noreferrer"><em>Service</em></a> objects which are
required to access a Pod.</p><p>You can introspect the Services also with <code>kubectl</code>:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> kubectl --namespace oauth2-demo get </span><span class="token function" style="color:#d73a49">service</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                             TYPE        CLUSTER-IP      EXTERNAL-IP   PORT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">S</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">                    AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">keycloak-http                    ClusterIP   </span><span class="token number" style="color:#36acaa">10.43</span><span class="token plain">.40.200    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">/TCP,8443/TCP,9990/TCP   62m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">keycloak-headless                ClusterIP   None            </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">/TCP                     62m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">keycloak-postgresql              ClusterIP   </span><span class="token number" style="color:#36acaa">10.43</span><span class="token plain">.231.210   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">5432</span><span class="token plain">/TCP                   62m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">keycloak-postgresql-headless     ClusterIP   None            </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">5432</span><span class="token plain">/TCP                   62m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">oauth2-demo                      ClusterIP   </span><span class="token number" style="color:#36acaa">10.43</span><span class="token plain">.160.68    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">8080</span><span class="token plain">/TCP                   62m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dashboard-kubernetes-dashboard   ClusterIP   </span><span class="token number" style="color:#36acaa">10.43</span><span class="token plain">.159.219   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">61348</span><span class="token plain">/TCP                  62m</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Please ignore the other services as they are not important for this example.<br>
<!-- -->Finally, please also check out the Pods in the cluster&#x27;s namespace with <code>kubectl</code>. It should be similar to:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> kubectl --namespace oauth2-demo get pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                              READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">oauth2-demo-675f5c55b5-xxj57                      </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">/2     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          63m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dashboard-kubernetes-dashboard-65dbdd8978-gd9jt   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          63m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">keycloak-postgresql-0                             </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          63m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">keycloak-0                                        </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          63m</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-oauth2-demo-sidecar-workload">The OAuth2-Demo Sidecar Workload<a href="#the-oauth2-demo-sidecar-workload" class="hash-link" aria-label="Direct link to The OAuth2-Demo Sidecar Workload" title="Direct link to The OAuth2-Demo Sidecar Workload">​</a></h3><p>If you want to know more about the implementation of the sidecar pattern in this example please head over to the
<a href="https://github.com/gefyrahq/gefyra-demos/blob/main/oauth2-demo/oauth2-demo.yaml#L37" target="_blank" rel="noopener noreferrer">workload manifest</a>.
The important part is that the Pod template specifies two containers. The first is <em>name: oauth2-proxy</em> and the second is
<em>name: oauth2-demo-app</em>:</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">containers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> oauth2</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> quay.io/oauth2</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">proxy/oauth2</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">proxy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">v7.2.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">imagePullPolicy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> IfNotPresent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">containerPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8809</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">protocol</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">envFrom</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">configMapRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> oauth2</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">oauth2proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> oauth2</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;quay.io/gefyra/oauth2-demo:latest&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">imagePullPolicy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">intern</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">containerPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8155</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">protocol</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Please have a closer look at the port configuration. The oauth2-proxy runs on port <em>8809</em> (with name <em>http</em>) and oauth2-demo-app
runs on port <em>8155</em>. You can describe the associated service with <code>kubectl</code> to see which of both ports the traffic is pointed to:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> kubectl -n oauth2-demo describe </span><span class="token function" style="color:#d73a49">service</span><span class="token plain"> oauth2-demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Name:              oauth2-demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Namespace:         oauth2-demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Labels:            app.kubernetes.io/instance</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">gefyra-demos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   app.kubernetes.io/name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">oauth2-demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Annotations:       </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Selector:          app.kubernetes.io/instance</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">gefyra-demos,app.kubernetes.io/name</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">oauth2-demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Type:              ClusterIP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IP Families:       </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IP:                </span><span class="token number" style="color:#36acaa">10.43</span><span class="token plain">.160.68</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IPs:               </span><span class="token number" style="color:#36acaa">10.43</span><span class="token plain">.160.68</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Port:              http  </span><span class="token number" style="color:#36acaa">8080</span><span class="token plain">/TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TargetPort:        http/TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Endpoints:         </span><span class="token number" style="color:#36acaa">10.42</span><span class="token plain">.1.4:8809</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Session Affinity:  None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Events:            </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>For the sidecar pattern to function, the service speaks to the target Pod on port <em>8809</em> which is served by the oauth2-proxy.
A closer review of oauth2-proxy&#x27;s configuration reveals to which address the proxy upstreams all requests:</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">OAUTH2_PROXY_UPSTREAMS</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;http://127.0.0.1:8155&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This is precisely the connection to the backend application <strong>in each Pod</strong>.  </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-openid-connect-flow-in-brief">The OpenID Connect Flow in Brief<a href="#the-openid-connect-flow-in-brief" class="hash-link" aria-label="Direct link to The OpenID Connect Flow in Brief" title="Direct link to The OpenID Connect Flow in Brief">​</a></h3><p>The following image depicts the OpenID Connect flow in brief how it is working in this example:</p><div align="center"><img loading="lazy" src="/img/usecases_oauth2-demo-oidc.png" alt="the OIDC flow in brief" class="img_ev3q"></div><p>As you can see, the OAuth2-Proxy only passes authenticated traffic to the backend application. That breaks
the application free from (potentially unsafe) custom OIDC code and authorization handling. <strong>This is standard procedure
and should not be part of your code</strong>. Make use of this pattern when having this requirement.  </p><p>Ok! Enough for the workload internals. Let&#x27;s check out how Gefyra helps out with fixing nasty bugs.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-example-bug">The Example Bug<a href="#the-example-bug" class="hash-link" aria-label="Direct link to The Example Bug" title="Direct link to The Example Bug">​</a></h2><p>If you hit the troublesome route <a href="http://oauth2-demo.127.0.0.1.nip.io:8080/items/123" target="_blank" rel="noopener noreferrer">http://oauth2-demo.127.0.0.1.nip.io:8080/items/123</a>
(with <em>123</em> as an example for any int value) you will face the <code>Internal Server Error</code> message. That is a <em>HTTP 500</em> status.
The code being executed can be found
here: <a href="https://github.com/gefyrahq/gefyra-demos/blob/main/oauth2-demo/app/main.py#L23" target="_blank" rel="noopener noreferrer">https://github.com/gefyrahq/gefyra-demos/blob/main/oauth2-demo/app/main.py#L23</a></p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token decorator annotation punctuation" style="color:#393A34">@app</span><span class="token decorator annotation punctuation" style="color:#393A34">.</span><span class="token decorator annotation punctuation" style="color:#393A34">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;/items/{item_id}&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get_item</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">item_id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> x_forwarded_access_token</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Optional</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Header</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> x_forwarded_access_token</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> jwt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">decode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x_forwarded_access_token</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> options</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;verify_signature&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mail </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;Email&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;item_id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> item_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Email&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> mail</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;item_id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> item_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Email&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;not given&quot;</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Of course, you are a very attentive reader and found the mistake immediately, but let&#x27;s move on for the sake of this example.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="gefyra-to-the-rescue">Gefyra to the Rescue<a href="#gefyra-to-the-rescue" class="hash-link" aria-label="Direct link to Gefyra to the Rescue" title="Direct link to Gefyra to the Rescue">​</a></h2><p>As always, the first would be to spin up Gefyra with
<code>gefyra up</code>. Please be sure to still have the development cluster active in your current <code>kubectl</code> context.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="running-a-development-instance-of-the-container">Running a Development Instance of the Container<a href="#running-a-development-instance-of-the-container" class="hash-link" aria-label="Direct link to Running a Development Instance of the Container" title="Direct link to Running a Development Instance of the Container">​</a></h3><p>In order to inspect the application and pinpoint the bug, it requires a local instance of the container. Ideally with a
debug server running. Since you need the sidecar in place (for the OIDC logic), the development instance must be placed
in a Pod with the sidecar pattern. Gefyra offers you a unique mechanism to achieve exactly that.
Start the development instance like so (set <code>LOCAL_DIR</code> to the directory where you&#x27;ve copied/cloned <code>gefyra-demos</code> to):</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">LOCAL_DIR</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/home/</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">/gefyra-demos/oauth2-demo/app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> gefyra run -i quay.io/gefyra/oauth2-demo -N myfastapi-demo </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -n oauth2-demo -v </span><span class="token variable" style="color:#36acaa">$LOCAL_DIR</span><span class="token plain">:/app </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    -c </span><span class="token string" style="color:#e3116c">&quot;bash -c &#x27;python -m debugpy --wait-for-client --listen 0.0.0.0:5678 -m uvicorn main:app --host 0.0.0.0 --port 8155 --reload&#x27;&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>No worries, the following explains the parameter list:</p><ul><li><em>-i quay.io/gefyra/oauth2-demo</em>: run the Docker image which is also running in the cluster</li><li><em>-N myfastapi-demo</em>: name this local Docker instance <em>myfastapi-demo</em> for further reference</li><li><em>-n oauth2-demo</em>: place this Docker instance in the Kubernetes namespace <em>oauth2-demo</em> (where this example plays)</li><li><em>-v /home/&lt;...&gt;/gefyra-demos/oauth2-demo/app:/app</em>: mount the source code on your disk to this Docker instance at <em>/app</em></li><li><em>-c &quot;CMD&quot;</em>: start this Docker instance with <a href="https://github.com/microsoft/debugpy" target="_blank" rel="noopener noreferrer"><em>debugpy</em></a>, the rest is like from the Kubernetes workload manifest of the application</li></ul><p><a href="https://github.com/microsoft/debugpy" target="_blank" rel="noopener noreferrer">debugpy</a> is an implementation of the <em>Debug Adapter Protocol</em> for Python. This protocol
is also available for a countless number of programming languages. It basically spins up a server, in this case waiting for
a debugger client to connect, and runs the application wrapped in with debugging capabilities.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="attaching-a-debugger-to-the-development-instance">Attaching a Debugger to the Development Instance<a href="#attaching-a-debugger-to-the-development-instance" class="hash-link" aria-label="Direct link to Attaching a Debugger to the Development Instance" title="Direct link to Attaching a Debugger to the Development Instance">​</a></h3><p>Now that you are running a development instance with this Docker image locally, you need to connect the debugger client.
This example is prepared with <em>VSCode</em> and the Python extension installed.<br>
<!-- -->In order to do that, you need to find out the local IP address Gefyra assigned to your container with:
{% raw %}</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> inspect -f </span><span class="token string" style="color:#e3116c">&#x27;{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}&#x27;</span><span class="token plain"> myfastapi-demo</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>{% endraw %}
This will be part of the CLI soon (or maybe it already is). The command shown tells the IP of the container which is
needed for VSCode.  </p><p>Please get the code for the backend application from <a href="https://github.com/gefyrahq/gefyra-demos/tree/main/oauth2-demo/app" target="_blank" rel="noopener noreferrer">the repository</a> and
open up VSCode.  </p><p>Select the <em>Remote Attach</em> option to connect to the running debugpy instance at the given IP. The port is <em>5678</em> (please review the command above).</p><div align="center"><img loading="lazy" src="/img/usecases_oauth2-demo_vscode1.png" alt="starting the VSCode remote debugger" class="img_ev3q"></div><p>In the <em>DEBUG CONSOLE</em> it will display the following output: </p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">INFO:     Will watch for changes in these directories: [&#x27;/app&#x27;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO:     Uvicorn running on http://0.0.0.0:8155 (Press CTRL+C to quit)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INFO:     Started reloader process [438166] using watchgod</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Awesome. You have a debugger connected to the development instance. Now it&#x27;s time to receive a request from the oauth2-proxy container.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="bridging-the-development-instance-in-the-cluster">Bridging the Development Instance in the Cluster<a href="#bridging-the-development-instance-in-the-cluster" class="hash-link" aria-label="Direct link to Bridging the Development Instance in the Cluster" title="Direct link to Bridging the Development Instance in the Cluster">​</a></h3><p>In order to receive requests (i.e. traffic) from within the cluster, basically when you hit the route <a href="http://oauth2-demo.127.0.0.1.nip.io:8080/items/123" target="_blank" rel="noopener noreferrer">http://oauth2-demo.127.0.0.1.nip.io:8080/items/123</a>
in your browser, a <code>gefyra bridge ...</code> is needed.<br>
<!-- -->Just create a bridge with:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> gefyra bridge -N myfastapi-demo -n oauth2-demo </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      --target deploy/oauth2-demo/oauth2-demo-app </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      --port </span><span class="token number" style="color:#36acaa">8155</span><span class="token plain">:8155 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Creating bridge </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> Pod oauth2-demo-675f5c55b5-xxj57</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Waiting </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> the bridge</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> to become active</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Bridge myfastapi established</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The parameter list specifies the following:</p><ul><li><em>-N myfastapi-demo</em>: the bridge targets (on one end) the local Docker instance with the name <em>myfastapi-demo</em></li><li><em>-n oauth2-demo</em>: the target workload (the other end of the bridge) is in the Kubernetes namespace <em>oauth2-demo</em></li><li><em>-<!-- -->-<!-- -->deployment oauth2-demo</em>: Gefyra intercepts all Pods of the Deployment <em>oauth2-demo</em> (don&#x27;t confuse it with the name of the namespace)</li><li><em>-<!-- -->-<!-- -->port 8155:8155</em>: the bridge to map port 8155 of the container in the cluster to 8155 on the local instance</li><li><em>-<!-- -->-<!-- -->container-name oauth2-demo-app</em>: since this Pod contains multiple containers (see the sidecar pattern above), Gefyra is asked to intercept the application container <em>oauth2-demo-app</em></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="debugging-the-application">Debugging the Application<a href="#debugging-the-application" class="hash-link" aria-label="Direct link to Debugging the Application" title="Direct link to Debugging the Application">​</a></h3><p>Now you are ready to stop the execution of the code in your VSCode debugger.
Place the breakpoint anywhere near the position you would expect the error to happen:</p><div align="center"><img loading="lazy" src="/img/usecases_oauth2-demo_vscode2.png" alt="breakpoint in VSCode" class="img_ev3q"></div><p>Point your browser to <a href="http://oauth2-demo.127.0.0.1.nip.io:8080/items/123" target="_blank" rel="noopener noreferrer">http://oauth2-demo.127.0.0.1.nip.io:8080/items/123</a> again.</p><p>Once you hit the breakpoint, you can easily look around and introspect the JWT (json web token) issued from Keycloak and
verified with OAuth2-Proxy.</p><div align="center"><img loading="lazy" src="/img/usecases_oauth2-demo_vscode3.png" alt="introspecting variables and the JWT token" class="img_ev3q"></div><p>As you may see, the key in the token is written in a lowercase &quot;email&quot;. This is causing the <em>KeyError: &#x27;Email&#x27;</em> resulting
in a 500 error.  </p><p><strong>Remark:</strong> Of course you could have found this out reading the logs, but where is the fun? Anyway, debugging software is
a tool for hunting down causes of way more complex misbehaving then in this example.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="fixing-the-bug">Fixing the Bug<a href="#fixing-the-bug" class="hash-link" aria-label="Direct link to Fixing the Bug" title="Direct link to Fixing the Bug">​</a></h3><p>Since the development instance is started with your local source code mounted into the container and the <em>-<!-- -->-<!-- -->reload</em> flag turned on,
please move on and fix this bug. The fix looks like this:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> jwt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">decode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x_forwarded_access_token</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> options</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;verify_signature&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mail </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;email&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># the key is with a lowercase &#x27;email&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;item_id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> item_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Email&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> mail</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Once you have saved the changes, the application is immediately restarted with the fixed code.<br>
<!-- -->The output of the route <a href="http://oauth2-demo.127.0.0.1.nip.io:8080/items/123" target="_blank" rel="noopener noreferrer">http://oauth2-demo.127.0.0.1.nip.io:8080/items/123</a> is
now in the browser:</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;item_id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">123</span><span class="token punctuation" style="color:#393A34">,</span><span class="token property" style="color:#36acaa">&quot;Email&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;john@gefyra.dev&quot;</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Awesome! Commit and push.  </p><p>This way you can be quite sure that this will work in all Kubernetes environments provisioned with these workloads.  </p><p><strong>Remark:</strong> Gefyra is able to run and bridge as many applications as you need. This is useful in complex request/response
scenarios with multiple involved services - and potentially all with a debugger attached. Isn&#x27;t that neat?</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="shutting-down-gefyra">Shutting Down Gefyra<a href="#shutting-down-gefyra" class="hash-link" aria-label="Direct link to Shutting Down Gefyra" title="Direct link to Shutting Down Gefyra">​</a></h3><p>In order to clean everything up, you can run <code>gefyra down</code>. This will remove the running bridges and shut down the development
container instances. You will now find the cluster reset to the state with the original bug around. For the fix to become persistent
you will need to roll out a new version of the container image specified in the Kubernetes workload manifest.</p><h1>Remove the Development Infrastructure</h1><p>If you have initially created the development infrastructure using <code>Getdeck</code> you can now run:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> deck remove --cluster https://github.com/gefyrahq/gefyra-demos.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Deleting the k3d cluster with name gefyra-demos</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If you created the infrastructure yourself, you probably already know how to get rid of everything yourself ;-)</p><h1>Additional Notes</h1><p>If you want maximum convenience for your developers and a supported team oriented workflow, we recommend you
check out <a href="https://unikube.io" target="_blank" rel="noopener noreferrer">Unikube</a>.
Gefyra is part of Unikube&#x27;s development workflow.</p><p>If you are developing django applications, be sure to check out <a href="https://django-hurricane.io/" target="_blank" rel="noopener noreferrer">Django-Hurricane</a>, a Kubernetes-native
stack specifically created for django and <a href="https://github.com/Blueshoe/pycloak" target="_blank" rel="noopener noreferrer">Pycloak</a>, a package that&#x27;s makes it super easy to integrate
OpenID Connect/OAuth2 workflows in django.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/versioned_docs/version-1.x/usecases/oauth2-demo.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/1.x/usecases/ubuntu-in-namespace"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Run a Ubuntu container instance</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/1.x/usecases/remote-gke"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Remote Development on Google Kubernetes Engine</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#what-you-will-learn" class="table-of-contents__link toc-highlight">What you will learn</a></li><li><a href="#what-you-will-need" class="table-of-contents__link toc-highlight">What you will need</a></li><li><a href="#table-of-contents" class="table-of-contents__link toc-highlight">Table of contents</a></li><li><a href="#creating-the-development-infrastructure" class="table-of-contents__link toc-highlight">Creating the Development Infrastructure</a></li><li><a href="#getting-the-app-running" class="table-of-contents__link toc-highlight">Getting the App Running</a></li><li><a href="#the-scheme-of-the-infrastructure" class="table-of-contents__link toc-highlight">The Scheme of the Infrastructure</a><ul><li><a href="#kubernetes-overview" class="table-of-contents__link toc-highlight">Kubernetes Overview</a></li><li><a href="#the-oauth2-demo-sidecar-workload" class="table-of-contents__link toc-highlight">The OAuth2-Demo Sidecar Workload</a></li><li><a href="#the-openid-connect-flow-in-brief" class="table-of-contents__link toc-highlight">The OpenID Connect Flow in Brief</a></li></ul></li><li><a href="#the-example-bug" class="table-of-contents__link toc-highlight">The Example Bug</a></li><li><a href="#gefyra-to-the-rescue" class="table-of-contents__link toc-highlight">Gefyra to the Rescue</a><ul><li><a href="#running-a-development-instance-of-the-container" class="table-of-contents__link toc-highlight">Running a Development Instance of the Container</a></li><li><a href="#attaching-a-debugger-to-the-development-instance" class="table-of-contents__link toc-highlight">Attaching a Debugger to the Development Instance</a></li><li><a href="#bridging-the-development-instance-in-the-cluster" class="table-of-contents__link toc-highlight">Bridging the Development Instance in the Cluster</a></li><li><a href="#debugging-the-application" class="table-of-contents__link toc-highlight">Debugging the Application</a></li><li><a href="#fixing-the-bug" class="table-of-contents__link toc-highlight">Fixing the Bug</a></li><li><a href="#shutting-down-gefyra" class="table-of-contents__link toc-highlight">Shutting Down Gefyra</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/index">Docs</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discord.gg/8NTPMVPaKy" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/BLUESHOE_GmbH" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/gefyrahq/gefyra" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Gefyra, Blueshoe GmbH. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.7dcd39c8.js"></script>
<script src="/assets/js/main.4d529139.js"></script>
</body>
</html>